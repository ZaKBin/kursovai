:description: Курсовой проект
:toc:
:toc-title: Оглавление
:figure-caption: Рисунок
:table-caption: Таблица
:imagesdir: images
:important-caption: ВАЖНО!
:note-caption: ЗАМЕЧАНИЕ
:stem:

== Требования к разработке проекта

В данном проекте необходимо измерять напряжение с потенциометра и, используя значение напряжения, управлять ярокстью светодиода за счёт модуля PWM.

.Требования к курсовому проекту
|===
|Параметр/характеристика |Требование

|Отладочная плата
|XNUCLEO-F411RE

|Объект и характеристика для измерения
|Напряжение с потенциометра, установленного на плате расширения Accessories Shield

|Способ измерения напряжения
|Встроенный АЦП

|Период измерения
|50 мс

|Способ получения кода
|Механизм DMA

|Точность измерения
|Не менее 0,01 В

|Способ передачи значений
|По беспроводному интерфейсу через модуль BlueTooth Bee HC-06 или I/O Expansion Shield

|Способ общения с платой расширения
|USART2

|Архитектура
|В виде UML диаграммы

|Требование к приложению
|Язык C++ с использованием компилятора ARM 8.40.2 и использование FreeRTOS
|===

К измеренному напряжению должен быть применен цифровой фильтр вида:

stem:["tau" = int ((1-e^(-"dt"/("R"*"C")), "RC" > 0 sec), (1, RC = 0 sec));] 

stem:["FilteredValue" = "OldValue" + ("Valu"e" - "OldValue") * "tau"] ,


где stem:["dt"] - 100 мс; +
stem:[Value] – текущее нефильтрованное измеренное значение напряжения; +
stem:[OldValue] - предыдущее фильтрованное значение.

Для управления яркостью светодиода должен использоваться модуль PWM. Светодиод находится на порту PortC.8.

Формат вывода: +
"Напряжение: " X.XXX [V].

== Анализ требований к разработке

=== 1. Отладочная плата XNUCLEO-F411RE

Отладочная плаата XNUCLEO-F411RE - это улучшенная версия отладочной платы STM32 Nucleo, созданная компанией Waveshare. Основана XNUCLEO-F411RE на микроконтроллере STM32F411RET6 с ядром ARM Cortex-4 и предназначена для создания проектов и прототипирования. 

.Отладочная плата XNUCLEO-F411RE
image::XNUCLEO-F411RE.jpg[]

Основные особенности платы XNUCLEO-F411RE:

* совместимость с Arduino;
* подключение по USB;
* наличие светодиодов и пользовательской кнопки.

В ходе выполнения курсового проекта используется плата расширения Accessory Shield.

.Плата расширения Accessory Shield
image::accessory_shield.jpg[]

Accessory Shield - это плата расширения совместимая с популярными платформами для разработки электронных приложений, такими как Arduino UNO, Arduino Leonardo, NUCLEO, XNUCLEO и совместимыми. На плате установлены самые популярные дочерние модули, подходящие для реализации большинства задач.

Особенности платы расширения:

* разъем для подключения плат Arduino;
* разъем XBee для подключения беспроводных модулей;
* OLED дисплей 0,96 дюймов с разрешением 128x64 пикселей;
* RGB-светодиод;
* зуммер;
* потенциометр 10 кОм;
* 3-осевой цифровой акселерометр ADXL345;
* температурный датчик LM75BDP,
* джойстик 5-ти позиционный,
* индикатор состояния XBee,
* индикатор питания,
* кнопка сброса модулей XBee и Arduino,
* часы реального времени (RTC),
* держатель батареи CR1220 для RTC,
* драйвер RGB светодиода,
* джампер выбора режима Отладка/Связь.

=== 2. Софт должен измерять напряжения с переменного резистора, уставленного на плате расширения

Переменный резистор, установленный на плате расширения, согласно спецификации Waveshare, подключен к аналоговому входу микроконтроллера, пин *PA0*.

.Распиновка XNUCLEO-F411RE
image::xnucleo_spec.jpg[]

В плате расширения используется линейный потенциометр с тремя выводами:

* один крайний вывод подключен в питанию 3,3 В (стандартное напряжение питания);
* другой крайний вывод подключен к земле;
* центральный вывод выведен на аналоговый вход микроконтроллера (пин PA0).

Таким образом, при вращении ручки потенциометра напряжение на центральном выводе изменяется от 0 В до 3,3 В.

Поскольку напряжение - аналоговый сигнал, его нужно измерять с помощью аналого-цифрового преобразователя (АЦП).

=== 3. Для измерения напряжения должен использоваться встроенный АЦП с использованием DMA

Микроконтроллер STM32F411RET6 оснащен 12-битным АЦП, поддерживающим 19 каналов и позволяющим имзерять сигналы из 16 внешних источников, 2 внутренних источников, а также канал VBAT (измерение напряжения на линии питания резервной батареи).

Аналого-цифровое преобразование каналов может осуществляться в следующих режимах:

* Single Mode (однократное преобразование) - для выбранного канала преобразование выполняется один раз и останавливается после завершения.
* Continuous Mode (непрерывное преобразование) - автоматическое повторение преобразования выбранного канала без необходимости повторного запуска.
* Scan Mode (режим сканирования) - АЦП выполняет преобразование для группы каналов, заданных в последовательности, по одному за раз. Этот режим не является самостоятельным, а комбинируется с Single или Continuous.
* Discontinuous Mode (Прерывистый режим) - улучшенный режим  сканирования. Разбивает последовательность каналов на подгруппы. АЦП выполняет преобразование заданного числа каналов за один цикл, затем останавливается до следующего триггера.

Поскольку, согласно требованиям к ПО, измерять напряжение требуется с периодичностью 50 мс (т.е. по запросу), следует использовать однократное преобразование.

 Для того, чтобы настроить АЦП в режиме однократного преобразования, нужно:
 . подать тактирование на порт, который будет использоваться для считывания данных с АЦП;
 . настроить порт, подключенный к нужному каналу АЦП, на аналоговый вход;
 . подать тактирование на АЦП;
 . настроить разрешение АЦП;
 . настроить режим преобразования (регистр ADC_CR2);
 . выбрать нужный канал для измерения;
 . настроить канал АЦП на необходимую частоту преобразования;
 . включить АЦП;
 . начать преобразование;
 . дождаться флага готовности преобразования;
 . считать преобразованное значение.

В таблице ниже показаны настройки регистров, необходимых для включения АЦП в режиме одиночного преобразования.

.Настройки регистров для АЦП в режиме одиночного преобразования
|===
| Регистр | Поле (номера битов) | Значение | Назначение
| RCC_AHB1ENR | GPIOAEN (0) | 1 | Подать тактирование на порт GPIOA
| GPIOA_MODER | MODER0 (1 : 0) | 11 | Установить порт в режим аналогового входа
| RCC_APB2ENR | ADC1EN (8) | 1 | Подать тактирование на АЦП
| ADC_CR1 | RES (25 : 24) | 00 | Установить разрядность АЦП (12 бит)
.2+| ADC_CR2 | EOCS (10) | 1 | Установить тип окончания преобразования: Бит Окончания преобразования EOC устанавливается после окончания преобразования для каждого канала
| CONT (1) | 0 | Установить режим одиночного преобразования
| ADC_SQR1 | L (3 : 0) | 0000 | Установить количество преобразований равным 1
| ADC_SQR3 | SQ1 (4 : 0) | 0000 | Выбрать канал 0 для измерения
| ADD_CR2 | DMA (8) | 1 | Включить режим DMA
| ADC_SMPR2 | SMP0 (2: 0) | 100 | Установить время преобразования на 84 цикла
.2+| ADC_CR2 | ADON (0) | 1 | Запуск АЦП
| SWSTART (30) | 1 | Начать преобразование
| ADC_SR | EOC (1) | Зависит от того, окончилось ли преобразование | Проверка готовности преобразования
| ADC_DR | DATA (15 : 0) | Переменное | Используется для считывания преобразованных данных
|===

Согласно требованиям к ПО, для получения кода измерения должен использоваться механизм DMA. DMA - это режим обмена данными между периферией и основной памятью, в котором центральный процессор не участвует. Для работы с DMA в микроконтроллер встроены специальные контроллеры DMA.

На микроконтроллере STM32F411RET6 имеется 2 контроллера DMA, каждый из которых имеет 8 каналов, каждый канал имеет 8 потоков, которые подключаются к конкретному периферийному устройству. Если установлен бит DMA регистра ADC_CR2, то по окончании преобразования АЦП генерирует запрос DMA. Контроллер DMA получит этот запрос по внутренней линии связи между периферией и DMA. Затем контроллер DMA считывает данные с АЦП (записанные в регистр ADC_DR) и записывает их в указанный адрес памяти.

В спецификации к микроконтроллеру имеется таблица запросов DMA.

.Таблица запросов DMA
image::DMA_Requests_Tables.png[]

Согласно этой таблице, для того, чтобы генерировать запросы от АЦП, следует использовать контроллер DMA2, канал 0, потоки 0 или 4. В данной работе используется поток 0.

В таблице ниже показана конфигурация регистров DMA для данного проекта.

Алгоритм настройки потока DMA представлен в пункте 9.3.17 в Reference Manual к STM32F411RET6.

|===
| Регистр | Поле (номера битов) | Значение | Назначение
| RCC_AHB1ENR | DMA2EN (22) | 1 | Подать тактирование на контроллер DMA2
.8+| DMA_S0CR | CHSEL (27 : 25) | 000 | Выбор канала 0
| DIR (7 : 6) | 00 | Направление передачи данных: от периферии к памяти
| CIRC (8) | 0 | Циклический режим отключен (т.к. одиночное преобразование)
| MINC (10) | 0 | Отключить инкремент адреса памяти (для записи одного значения)
| PINC (9) | 0 | Отключить инкремент адреса периферии (т.к. адрес АЦП фиксирован)
| PSIZE (12 : 11) | 01 | Установить размер данных периферии 16 бит (поскольку АЦП 12-битный)
| MSIZE (14 : 13) | 01 | Установить размер данных памяти 16 бит
| EN (0) | 1 или 0 | Перед настройкой DMA бит установить в 0, после настройки запустить поток и установить бит в 1
| DMA_S0PAR | PAR (31 : 0) | Адрес регистра ADC_DR | Хранит адрес АЦП
| DMA_S0MA0R | MDA (31 : 0) | Адрес памяти, куда данные будут записываться | Хранит адрес памяти, куда сохраняется результат измерений
| DMA_S0NDTR | NDT (15 : 0) | Количество данных для передачи | Хранит количество передаваемых данных
|===

=== 4. Управление яркостью светодиода с использованием ШИМ и настройка регистра TIM3_ARR

Для управления яркостью светодиода в проекте используется модуль широтно-импульсной модуляции (ШИМ, PWM) на базе таймера TIM3 микроконтроллера STM32F411RET6. В соответствии с Datasheet - STM32F411xC был взят TIM3. ШИМ позволяет изменять яркость светодиода за счет регулировки скважности импульсов, подаваемых на порт PortC.8, к которому подключен светодиод. Значение яркости определяется измеренным напряжением с потенциометра, преобразованным в соответствующее значение для регистра сравнения TIM3_CCR3.

.Выбор таймера
image::TIM3_CH3.png[]

==== Принципы работы ШИМ
ШИМ в STM32F411RET6 реализуется с использованием таймеров, которые генерируют периодический сигнал с изменяемой шириной импульса. Таймер TIM3, используемый в проекте, работает в режиме ШИМ, где:

* Период сигнала задается значением регистра авто-перезагрузки TIM3_ARR.

* Ширина импульса определяется значением регистра сравнения TIM3_CCR3.

* Скважность (duty cycle) вычисляется как отношение значения TIM3_CCR3 к значению TIM3_ARR+1, умноженное на 100%.

В данном проекте значение TIM3_CCR3 рассчитывается по формуле:

stem:["CCRValue" = "VoltageValue" / ("MaxVoltage") * ("ARRValue+1)",]

где stem:["ARRValue"] - значение регистра TIM3_ARR,

Это позволяет пропорционально изменять яркость светодиода в зависимости от входного напряжения

==== Режимы работы таймера TIM3

Таймер TIM3 поддерживает несколько режимов работы, включая:

* Up-counting mode (счет вверх):счетчик увеличивается от 0 до значения TIM3_ARR, затем сбрасывается.
* Down-counting mode (счет вниз): счетчик уменьшается от TIM3_ARR до 0.
* Center-aligned mode (центрированный): счетчик считает вверх, затем вниз, создавая симметричный сигнал.
* PWM Mode 1: при счете вверх сигнал высокий, пока счетчик меньше TIM3_CCRx, затем низкий.
* PWM Mode 2: противоположная логика PWM Mode 1.

==== Настройка таймера TIM3 для ШИМ

Для настройки таймера TIM3 в режиме ШИМ необходимо выполнить следующие шаги:

. Подать тактирование на таймер TIM3 через регистр RCC_APB1ENR.
. Настроить порт GPIOC (PortC.8) в режим альтернативной функции для вывода ШИМ-сигнала.
. Установить режим работы таймера (счет вверх, предделитель, значение авто-перезагрузки).
. Настроить канал таймера (в данном случае канал 3) для работы в режиме ШИМ.
. Активировать выход канала и включить таймер.
. Настроить значение регистра TIM3_ARR для задания периода ШИМ-сигнала.

В таблице ниже приведены настройки регистров для включения ШИМ на таймере TIM3.

|===
|Регистр| Поле (номера битов)| Значение| Назначение
|RCC_AHB1ENR| GPIOCEN (2)| 1 |Подать тактирование на порт GPIOC
|GPIOC_MODER|MODER8 (17:16)|10|Установить PortC.8 в режим альтернативной 
|GPIOC_AFRH|AFRH8 (3:0)|0010 (AF2)|Назначить альтернативную функцию AF2 (TIM3_CH3) для PortC.8
|RCC_APB1ENR|TIM3EN (1)|1|Подать тактирование на таймер TIM3
|TIM3_CR1|DIR (4)|0|Установить режим счета вверх
|TIM3_CR1|ARPE (7)|1|Включить буферизацию регистра TIM3_ARR
|TIM3_ARR|ARR (15:0)|2000|Установить период ШИМ (значение регистра авто-перезагрузки)
|TIM3_CCMR2|CC3S (1:0)|00|Установить канал 3 как выход
|TIM3_CCMR2|OC3M (6:4)|110|Установить режим PWM Mode 1 для канала 3
|TIM3_CCMR2|OC3PE (3)|1|Включить буферизацию регистра TIM3_CCR3
|TIM3_CCER|CC3E (8)|1|Активировать выход канала 3
|TIM3_CCER|CC3P (9)|0|Установить полярность канала 3 (активный уровень — высокий)
|TIM3_CCR3|CCR3 (15:0)|Переменное|Установить ширину импульса (зависит от измеренного напряжения)
|TIM3_CR1|CEN (0)|1|Включить таймер TIM3






















